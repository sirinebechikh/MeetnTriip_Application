{% extends 'Gestion_Evennement/base.html.twig' %}

{% block title %}Complete Your Booking - MeetNTrip
{% endblock %}

{% block body %}
	<!-- Spinner Start -->
	<div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
		<div class="spinner-border text-secondary" style="width: 3rem; height: 3rem;" role="status">
			<span class="sr-only">Loading...</span>
		</div>
	</div>
	<!-- Spinner End -->

	<div class="container py-5">
		<h1 class="text-center mb-5 wow fadeInUp" data-wow-delay="0.1s">Complete Your Booking</h1>

		<div class="card shadow-lg mb-5 wow fadeInUp" data-wow-delay="0.2s">
			<div class="card-header bg-primary text-white py-3">
				<h2 class="mb-0">
					<i class="fas fa-clipboard-list me-2"></i>
					Booking Summary</h2>
			</div>
			<div class="card-body">
				<div class="row g-4">
					{% if flight %}
						<div class="col-md-6 col-lg-4">
							<div class="border rounded p-3 h-100">
								<h3 class="text-primary">
									<i class="fas fa-plane me-2"></i>
									Flight</h3>
								<div class="ms-4">
                                    {# Fixed date parsing logic #}
                                    {% set dateDebut = date(date_debut) %}
                                    {% set dateFin = date(date_fin) %}
                                    
                                    {% if flight.destination in ['Paris', 'Dubai', 'London', 'Istanbul', 'Riyadh', 'Madrid'] %}
                                        {% set departureDate = dateDebut|date_modify('-1 day') %}
                                        {% set returnDate = dateFin|date_modify('+1 day') %}
                                    {% elseif flight.destination in ['New York', 'Tokyo', 'Beijing', 'Sydney', 'Ottawa'] %}
                                        {% set departureDate = dateDebut|date_modify('-2 days') %}
                                        {% set returnDate = dateFin|date_modify('+1 day') %}
                                    {% else %}
                                
                                    {% endif %}
                                
                                <p>
                                    <strong>Departure:</strong>
                                    {{ departureDate|date('Y-m-d') }} {{ flight.departureTime|date('H:i') }}
                                </p>
                                <p>
                                    <strong>Return:</strong>
                                    {{ returnDate|date('Y-m-d') }} {{ flight.backTime|date('H:i') }}
                                </p>
									<p>
										<strong>Airline:</strong>
										{{ flight.airline }}</p>
									<p>
										<strong>Destination:</strong>
										{{ flight.destination }}</p>
								
									<p class="h5 text-end">
										<strong>Price:</strong>
										${{ flight.price|number_format(2) }}</p>
								</div>
							</div>
						</div>
					{% endif %}

					{% if hotel %}
						<div class="col-md-6 col-lg-4">
							<div class="border rounded p-3 h-100">
								<h3 class="text-primary">
									<i class="fas fa-hotel me-2"></i>
									Hotel</h3>
								<div class="ms-4">
									<p>
										<strong>Name:</strong>
										{{ hotel.name }}</p>
									<p>
										<strong>Location:</strong>
										{{ hotel.location }}</p>
									<p>
										<strong>Price per night:</strong>
										${{ hotel.pricePerNight|number_format(2) }}</p>
									<p>
										<strong>Rating:</strong>
										{% for i in 1..5 %}
											{% if i <= hotel.rating %}
												<i class="fas fa-star text-warning"></i>
											{% else %}
												<i class="far fa-star text-warning"></i>
											{% endif %}
										{% endfor %}
									</p>
								</div>
							</div>
						</div>
					{% endif %}

					{% if location %}
						<div class="col-md-6 col-lg-4">
							<div class="border rounded p-3 h-100">
								<h3 class="text-primary">
									<i class="fas fa-building me-2"></i>
									Venue</h3>
								<div class="ms-4">
									<p>
										<strong>Name:</strong>
										{{ location.name }}</p>
									<p>
										<strong>Price per day:</strong>
										${{ location.pricePerDay|number_format(2) }}</p>
									{% if location.address %}
										<p>
											<strong>Address:</strong>
											{{ location.address }}</p>
									{% endif %}
								</div>
							</div>
						</div>
					{% endif %}

					{% if transport %}
						<div class="col-md-6 col-lg-4">
							<div class="border rounded p-3 h-100">
								<h3 class="text-primary">
									<i class="fas
																																									{% if transport.type == 'Bus' %}fa-bus
																																									{% elseif transport.type == 'Limousine' %}fa-car
																																									{% elseif transport.type == 'Shuttle' %}fa-shuttle-van
																																									{% else %}fa-taxi{% endif %}
																																								me-2"></i>
									Transport
								</h3>
								<div class="ms-4">
									<p>
										<strong>Type:</strong>
										{{ transport.type }}</p>
									<p>
										<strong>Price:</strong>
										${{ transport.price|number_format(2) }}</p>
									{% if transport.description %}
										<p>
											<strong>Details:</strong>
											{{ transport.description }}</p>
									{% endif %}
								</div>
							</div>
						</div>
					{% endif %}
				</div>

				<div class="mt-4 p-3 bg-light rounded">
					<div class="row">
						<div class="col-md-6">
							<h4 class="text-primary">
								<i class="fas fa-info-circle me-2"></i>
								Event Details</h4>
							<p>
								<strong>Dates:</strong>
								{{ date_debut }}
								to
								{{ date_fin }}</p>
							<p>
								<strong>Number of Guests:</strong>
								{{ nombre_invite }}</p>
						</div>
						<div class="col-md-6 text-end">
							<h2 class="text-primary">Total: ${{ price_total|number_format(2) }}</h2>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="card shadow-lg wow fadeInUp" data-wow-delay="0.3s">
			<div class="card-header bg-primary text-white py-3">
				<h2 class="mb-0">
					<i class="fas fa-edit me-2"></i>
					Finalize Booking</h2>
			</div>
			<div class="card-body">
				<form method="POST" action="{{ path('app_booking_save') }}" onsubmit="return validateForm()">
					{# Hidden fields to pass all selection data #}
					<input type="hidden" name="flight_id" value="{{ flight_id }}">
					<input type="hidden" name="hotel_id" value="{{ hotel_id }}">
					<input type="hidden" name="transport_id" value="{{ transport_id }}">
					<input type="hidden" name="location_id" value="{{ location_id }}">
					<input type="hidden" name="userid" value="{{ userid }}">
					{# Add hidden fields for event data #}
					<input type="hidden" name="id_evenement" value="{{ id_evenement }}">
					<input type="hidden" name="date_debut" value="{{ date_debut }}">
					<input type="hidden" name="date_fin" value="{{ date_fin }}">
					<input type="hidden" name="nombre_invite" value="{{ nombre_invite }}">

					<div class="mb-4">
						<label for="special_requests" class="form-label">
							<i class="fas fa-comment-dots me-2"></i>
							Special Requests</label>
						<textarea class="form-control" 
									id="special_requests" 
									name="special_requests" 
									rows="3" 
									placeholder="Any special requirements or notes...">{{ app.request.request.get('special_requests') }}</textarea>
						<div class="invalid-feedback" id="special_requests_error" style="display: none">
							Special requests must contain at least 10 characters
						</div>
					</div>

					<div class="form-check mb-4">
						<input class="form-check-input" 
								 type="checkbox" 
								 id="terms" 
								 name="terms">
						<label class="form-check-label" for="terms">
							<i class="fas fa-file-signature me-2"></i>
							I agree to the terms and conditions
						</label>
						<div class="invalid-feedback" id="terms_error" style="display: none">
							You must agree to the terms and conditions
						</div>
					</div>

					<div class="d-grid gap-2 d-md-flex justify-content-md-end">
						<button type="submit" class="btn btn-success btn-lg px-5 py-3">
							<i class="fas fa-check-circle me-2"></i>
							Confirm Booking
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
	function validateForm() {
		const specialRequests = document.getElementById('special_requests');
		const termsCheckbox = document.getElementById('terms');
		let isValid = true;

		// Reset previous errors
		specialRequests.classList.remove('is-invalid');
		termsCheckbox.classList.remove('is-invalid');
		document.getElementById('special_requests_error').style.display = 'none';
		document.getElementById('terms_error').style.display = 'none';

		// Validate special requests
		if (specialRequests.value.trim().length < 10) {
			specialRequests.classList.add('is-invalid');
			document.getElementById('special_requests_error').style.display = 'block';
			isValid = false;
		}

		// Validate terms checkbox
		if (!termsCheckbox.checked) {
			termsCheckbox.classList.add('is-invalid');
			document.getElementById('terms_error').style.display = 'block';
			isValid = false;
		}

		return isValid;
	}
	</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="{{ asset('assets/lib/wow/wow.min.js') }}"></script>
	<script src="{{ asset('assets/lib/easing/easing.min.js') }}"></script>
	<script src="{{ asset('assets/lib/waypoints/waypoints.min.js') }}"></script>
	<script src="{{ asset('assets/lib/counterup/counterup.min.js') }}"></script>
	<script src="{{ asset('assets/lib/owlcarousel/owl.carousel.min.js') }}"></script>
	<script src="{{ asset('assets/js/main.js') }}"></script>
{% endblock %}
