{% extends 'Gestion_Evennement/base.html.twig' %}

{% block title %}New Post{% endblock %}

{% block body %}
<div class="container py-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Create New Post</h4>
                </div>
                <div class="card-body">
                    {{ form_start(form) }}
                        <div class="mb-3">
                            {{ form_label(form.content, null, {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.content, {'attr': {'class': 'form-control', 'rows': 5}}) }}
                        </div>
                        <div class="mb-3">
                            {{ form_label(form.type, null, {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.type, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="mb-3">
                            {{ form_label(form.mediaFile, 'Upload Media (Image/Video)', {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.mediaFile, {'attr': {'class': 'form-control'}}) }}
                            <small class="text-muted">Supported formats: Images (jpg, png, gif) and Videos (mp4, webm)</small>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ button_label|default('Save Post') }}
                        </button>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.querySelector('#form_type');
    const contentField = document.querySelector('#form_content');
    const generateBtn = document.createElement('button');
    
    generateBtn.type = 'button';
    generateBtn.className = 'btn btn-outline-primary mt-2';
    generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate with AI';
    generateBtn.disabled = true;

    contentField.parentNode.insertBefore(generateBtn, contentField.nextSibling);

    typeSelect.addEventListener('change', function() {
        generateBtn.disabled = !this.value;
    });

    generateBtn.addEventListener('click', async function() {
        if (!typeSelect.value) return;
        
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';

 
        try {
            const response = await fetch(`/forum/generate-post-content/${typeSelect.value}`);
            
  
            const responseText = await response.text();
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${responseText.substring(0, 100)}`);
            }
            
    
            const data = JSON.parse(responseText);
            
            if (data.error) throw new Error(data.error);
            contentField.value = data.content;
        } catch (error) {
            console.error('Generation error:', error);
            alert(error.message);
        } finally {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-magic me-2"></i>Generate with AI';
        }
    });
});
</script>

{% endblock %}